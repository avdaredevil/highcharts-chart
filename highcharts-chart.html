<link rel="import" href="../polymer/polymer.html">
<script src="../jquery/dist/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/drilldown.js"></script>

<dom-module id="highcharts-chart">
    <template>
        <style>
            :host {width: 100%;display: inline-block}
            #Chart {@apply(--highcharts-chart-container);}
        </style>
        <div id="Chart" width="100%" on-click="_checkSelected"></div>
    </template>
    <script>
        'use strict';
        Highcharts.setOptions({global: {useUTC: false}});
        Polymer({
            is: "highcharts-chart",
            properties: {
                type: {type: String, value: 'spline', observer: '_updateType'},
                title: {type: String, value: "Highcharts Chart", observer: "_titleUpdate"},
                subtitle: {type: String, value: "", observer: "_subtitleUpdate"},
                showAxes: {type: Array, value: ()=>{return ['bottom','left']}},
                credits: {type: Boolean, value: false, reflectToAttribute:true},
                colorByPoint: {type: Boolean, value: false, reflectToAttribute:true},
                legend: {type: Boolean, value: false, reflectToAttribute:true},
                chartOptions: {type: Object, value: ()=>{return {}}},
                xAxis: {type: Object, value: ()=>{return {}}, observer: "_xAxisUpdate"},
                xLabel: {type: String, value: "X-Axis"},
                yLabel: {type: String, value: "Y-Axis"},
                label: {type: String, value: ""},
                data: {type: Array, value: ()=>{return []}, observer:"setData"},
                series: {type: Object, value: ()=>{return {}}},
                vsTime: {type: Boolean, value: false},
                loading: {type: Boolean, value: false, observer: "_loadingUpdate", reflectToAttribute:true},
                loadingMessage: {type: String, value: ""},
                selected: {type: Boolean, value: false, readOnly: true, notify: true, reflectToAttribute: true},
                selectedPoints: {type: Array, readOnly: true, notify: true},
                export: {type: Boolean, value: false, reflectToAttribute: true},
                xZoom: {type: Boolean, value: false, reflectToAttribute: true},
                yZoom: {type: Boolean, value: false, reflectToAttribute: true},
                //Custom Chart Declarations
                legendHorizAlign: {type: String, value: "right"},
                legendVertAlign: {type: String, value: "top"},
                legendPos: {type: Object, value: ()=>{return {x: -40,y: 80}}},
                legendOptions: {type: Object, value: ()=>{return {}}},
                tooltipOptions: {type: Object, value: ()=>{return {}}},
                _chart: {type: Object, readOnly: true}},
            ready: function() {
                var xAxis = $.extend(this.vsTime?{type: 'datetime',tickPixelInterval: 150}:{},this.xAxis);
                var Series = [{name: (this.label||this.xLabel),colorByPoint: this.colorByPoint, data: this.data}]
                var __app = this
                this._set_chart(new Highcharts.Chart({
                    chart: $.extend({
                        renderTo: this.$.Chart,
                        defaultSeriesType: this.type,
                        animation: Highcharts.svg, // don't animate in old IE
                        marginRight: 10,
                        events: {
                            click: function(e){__app.fire("chart-click",{e: e,chart: this})},
                            load: function(e){__app.fire("chart-load",{e: e,chart: this})},
                            beforePrint: function(e){__app.fire("before-print",{e: e,chart: this})},
                            afterPrint: function(e){__app.fire("after-print",{e: e,chart: this})},
                            addSeries: function(e){__app.fire("series-added",{e: e,chart: this})},
                            drilldown: function(e){__app.fire("drill-down",{e: e,chart: this})},
                            drillup: function(e){__app.fire("drill-up",{e: e,chart: this})},
                            selection: function(e){__app.fire("selection",{e: e,chart: this})},
                        }
                    },this.xZoom||this.yZoom?{zoomType: (this.xZoom&&"x")+(this.yZoom&&"y")}:{}),
                    //Properties
                    title: {text: this.title},
                    subtitle: {text: this.subtitle},
                    xAxis: xAxis,
                    credits: this.credits,
                    plotOptions: $.extend({
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                style: {color: (Highcharts.theme && Highcharts.theme.contrastTextColor)||'black'}
                            }
                        }
                    }, this.chartOptions),
                    yAxis: {
                        title: {text: (this.label||this.yLabel)},
                        plotLines: [{value: 0,width: 1,color: '#808080'}]
                    },
                    tooltip: $.extend(this.vsTime?{formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                Highcharts.numberFormat(this.y, 2);
                        }}:{},this.tooltipOptions),
                    legend: $.extend({enabled: this.legend, layout: "vertical", verticalAlign: this.legendVertAlign, align: this.legendHorizAlign, x: this.legendPos.x, y: this.legendPos.y, backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'), shadow: true},this.legendOptions),
                    exporting: {enabled: this.export},
                    series: this.series || Series,
                    drilldown: {series: []}
                }))
                this.async(()=>{this._loadingUpdate();window.dispatchEvent(new Event('resize'))},50)
            },
            setData: function(x,z) {if(!this._chart){return};if (typeof z != "number"){z=0}this._chart.series[z].setData(x)},
            addData: function(x,y,z,drillable) {this.pushData(x,y,z,true,drillable)},
            pushData: function(x,y,z,append,drillable) {if(!this._chart){return}
                if (typeof z=="boolean") {drillable = true;z=0}
                this._chart.series[(z||0)].addPoint(drillable?{name:x,y:y,drilldown:true}:[x,y],true,!append)
            },
            addSeries: function(name,data,colorByPoint,otherOptions) {this._chart.addSeries($.extend({name: name, data: (data||[]), colorByPoint: typeof colorByPoint=="undefined"?this.colorByPoint:colorByPoint},typeof otherOptions == "object"?otherOptions:{}),true)},
            addDrillSeries: function(point,data,name) {this._chart.addSeriesAsDrilldown(point, {name: name, data: data})},
            removeSeries: function(z) {this._getSeries(z).remove()},
            updateSeries: function(k,v,z) {var NewEl = {};if(typeof k=="object"){NewEl = k;z=v||z}else{NewEl[k]=v};this._getSeries(z).update(NewEl)},
            showLoading: function(d) {this.loadingMessage=d;this.loading=true},
            resizeChart: function() {this._chart.setSize(this.$.Chart.offsetWidth,this.offsetHeight)},
            destroy: function() {this._chart.destroy()},
            _getSeries: function(z) {if(!this._chart){return this._returnDummySeries()};z=z||0;var s=this._chart.series;if(!s.length){this._warn("Chart is empty [no series]");return this._returnDummySeries()};if (z<s.length){return s[(z||0)]}else{this._warn("Index z out of bounds");return this._returnDummySeries()}},
            _warn: function(err) {console.warn("%c[highcharts-chart]","font-weight:bold;background-color:yellow",err)},
            _updateType: function(t) {this.updateSeries("type",t)},
            _checkSelected: function() {if(!this._chart){return};var points = this._chart.getSelectedPoints();this._setSelected(!!points.length);this._setSelectedPoints(points)},
            _xAxisUpdate: function() {if(!this._chart){return};this._chart.xAxis[0].update(this.xAxis)},
            _titleUpdate: function() {if(!this._chart){return};this._chart.setTitle({text: this.title})},
            _loadingUpdate: function() {if(!this._chart){return};this._chart[(this.loading?"show":"hide")+"Loading"](this.loadingMessage)},
            _subtitleUpdate: function() {if(!this._chart){return};this._chart.setTitle(null,{text: this.subtitle})},
            _returnDummySeries: ()=>{return {update: ()=>{},remove: ()=>{}}}
        });
    </script>
</dom-module>
